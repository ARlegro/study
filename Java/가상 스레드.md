> **ê°€ìƒ ìŠ¤ë ˆë“œ (Virtual Threads)**
>

## ê°œë… ë° íŠ¹ì¥ì 

**ê°œë…**

- Java 21ì—ì„œ ì¶”ê°€ëœ **ê°€ë²¼ìš´ ìŠ¤ë ˆë“œ êµ¬í˜„**
- ê¸°ì¡´ `Thread`ë³´ë‹¤ ë©”ëª¨ë¦¬ ì†Œë¹„ê°€ ì ê³ , OS ìŠ¤ë ˆë“œë³´ë‹¤ ë§ì€ ìˆ˜ë¥¼ ìƒì„± ê°€ëŠ¥í•´ì„œ ì£¼ëª©ë°›ê³  ìˆìŒ

```kotlin
// ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ê°€ìƒ ìŠ¤ë ˆë“œ ì‹¤í–‰ê¸°
VirtualThreadTaskExecutor springVte = new VirtualThreadTaskExecutor();
// ìë°” JDK 21ì—ì„œ ì œê³µí•˜ëŠ” ê°€ìƒ ìŠ¤ë ˆë“œ ì‹¤í–‰ê¸°
ExecutorService jdkVte = Executors.newVirtualThreadPerTaskExecutor();

System.out.println("ìŠ¤í”„ë§ ê°€ìƒ ìŠ¤ë ˆë“œ : " + springVte.getClass());
//class org.springframework.core.task.VirtualThreadTaskExecutor
System.out.println("JDK ê°€ìƒìŠ¤ë ˆë“œ : " + jdkVte.getClass());
// class java.util.concurrent.ThreadPerTaskExecutor

vte.submit(Runnable or Callable);  <<< ë‘˜ ë‹¤ ê°€ëŠ¥ 
```

ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ê°€ìƒìŠ¤ë ˆë“œ Executorê°€ ìˆê³ , ìë°” jdkì—ì„œ ì œê³µí•˜ëŠ” ê°€ìƒ ìŠ¤ë ˆë“œ Executorê°€ ìˆë‹¤.

ë‘˜ì˜ ì°¨ì´ëŠ” ë‚˜ì¤‘ì— ì•Œì•„ë³´ì

### **ì¥ì  ì •ë¦¬**

1. **ê²½ëŸ‰í™”ëœ ìŠ¤ë ˆë“œ**
    - **ê¸°ì¡´ì˜ í”Œë«í¼ ìŠ¤ë ˆë“œ : ìš´ì˜ì²´ì œ(OS) ìŠ¤ë ˆë“œì™€ 1:1ë¡œ ë§¤í•‘**ë˜ê¸° ë•Œë¬¸ì—, ë§ì€ ìˆ˜ì˜ ìŠ¤ë ˆë“œë¥¼ ìƒì„±í•˜ë©´ **ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ë¹„ìš©ì´ ì¦ê°€í•˜ê³  ë©”ëª¨ë¦¬ ë¶€ë‹´ì´ ì»¤ì§**
    - **ê°€ìƒ ìŠ¤ë ˆë“œ** : **JVM ë‚´ë¶€ì—ì„œ ê´€ë¦¬**ë˜ë©°, **OS ìŠ¤ë ˆë“œì™€ ì§ì ‘ ì—°ê²°ë˜ì§€ ì•ŠìŒ** â†’ í›¨ì”¬ ê°€ë²¼ì›€.
    - ë”°ë¼ì„œ, **ìˆ˜ì²œ~ìˆ˜ë°±ë§Œ ê°œì˜ ë™ì‹œ ì‹¤í–‰ ì‘ì—…ì„ ì²˜ë¦¬** ê°€ëŠ¥

1. **ë¸”ë¡œí‚¹ I/O ì‘ì—…ì—ì„œ íš¨ìœ¨ì **
    - ê°€ìƒ ìŠ¤ë ˆë“œëŠ” **ë¸”ë¡œí‚¹ I/O(Network, DB, File)ì—ì„œ í° ì„±ëŠ¥ í–¥ìƒ**
    - **ê¸°ì¡´ í”Œë«í¼ ìŠ¤ë ˆë“œ** : ë¸”ë¡œí‚¹ ìƒíƒœì—ì„œ **OS ìì›ì„ ì°¨ì§€í•˜ë©´ì„œ ê¸°ë‹¤ë¦¼** â†’ ë¹„íš¨ìœ¨ì 
    - **ê°€ìƒ ìŠ¤ë ˆë“œ** : **ë¸”ë¡œí‚¹ ë°œìƒ ì‹œ ìë™ìœ¼ë¡œ OS ìŠ¤ë ˆë“œì—ì„œ í•´ì œë˜ë©°, ë‹¤ë¥¸ ê°€ìƒ ìŠ¤ë ˆë“œê°€ ì‹¤í–‰ë¨**
        - ì¦‰, **ë¸”ë¡œí‚¹ ì‹œê°„ ë™ì•ˆ OS ìŠ¤ë ˆë“œê°€ ë‚­ë¹„ë˜ì§€ ì•ŠìŒ**
        - ëŒ€ëŸ‰ì˜ ë¸”ë¡œí‚¹ I/O ì‘ì—…ì´ ìˆëŠ” ì„œë²„(ì˜ˆ: HTTP í†µì‹ , DB ìš”ì²­, íŒŒì¼ ì²˜ë¦¬ ë“±)ì—ì„œ ì„±ëŠ¥ ìµœì í™”
        - ì´ë¡œ ì¸í•´, **`CompletableFuture`ë‚˜ `Reactor` ê°™ì€ ë³µì¡í•œ ë¹„ë™ê¸° ì²˜ë¦¬ ì—†ì´ë„ ë™ê¸° ì½”ë“œ ìŠ¤íƒ€ì¼ ìœ ì§€ ê°€ëŠ¥**
    - ë” ì ì€ í”Œë«í¼ ìŠ¤ë ˆë“œë¡œ **ë” ë§ì€ ìš”ì²­ ì²˜ë¦¬ ê°€ëŠ¥**

1. **ê¸°ì¡´ `Thread`ë³´ë‹¤ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ë¹„ìš©ì´ ë‚®ìŒ**
    - **ê¸°ì¡´ í”Œë«í¼ ìŠ¤ë ˆë“œ** : OSê°€ **í•˜ë“œì›¨ì–´ ë ˆë²¨ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­**ì„ ìˆ˜í–‰ â†’ ë¹„ìš© í¼
    - **ê°€ìƒ ìŠ¤ë ˆë“œ** : **JVMì´ ì§ì ‘ ê´€ë¦¬í•˜ëŠ” ì‚¬ìš©ì ëª¨ë“œ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ì„ ìˆ˜í–‰** â†’ ë¹„ìš©ì´ ë‚®ìŒ. ë‹¤ì‹œ ë§í•´, ê°€ìƒ ìŠ¤ë ˆë“œëŠ” **JVM ë‚´ë¶€ ìŠ¤ì¼€ì¤„ë§ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì „í™˜ ë¹„ìš©ì´ ì ìŒ**
    - **ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ë‚®ì€ ì´ìœ  - ìì„¸í•œ ë¶„ì„**

      âœ… ê°€ìƒ ìŠ¤ë ˆë“œëŠ” OS ìŠ¤ë ˆë“œì™€ 1:1 ë§¤í•‘ë˜ì§€ ì•Šê³ , **ë§ì€ ê°€ìƒ ìŠ¤ë ˆë“œê°€ ì†Œìˆ˜ì˜ í”Œë«í¼ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë¨.**

      âœ… **I/O ë¸”ë¡œí‚¹ì´ ë°œìƒí•˜ë©´ ìë™ìœ¼ë¡œ í•´ì œë˜ê³ , ë‹¤ë¥¸ ê°€ìƒ ìŠ¤ë ˆë“œê°€ ì‹¤í–‰ë¨.**

      âœ… **ë ˆì§€ìŠ¤í„° ë° ìºì‹œ ì˜¤ë²„í—¤ë“œê°€ ì¤„ì–´ë“¤ì–´ ì„±ëŠ¥ì´ í–¥ìƒë¨.**

    - CPU ì‚¬ìš©ë¥  ì¦ê°€í•˜ê¸´ í•˜ì§€ë§Œ CPUê°€ ì¶©ë¶„í•˜ë‹¤ë©´ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ë¹„ìš©ì„ ì¤„ì—¬ì£¼ëŠ” ê²ƒì´ ì»¤ì„œ â†’ ì²˜ë¦¬ëŸ‰(Throughput) í–¥ìƒ

        <aside>
        ğŸ’¡

      **ì°¸ê³  - ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ë¹„ìš©ì´ë€?**

        - CPUê°€ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ìŠ¤ë ˆë“œì˜ ìƒíƒœ(Context)ë¥¼ ì €ì¥í•˜ê³ , ë‹¤ë¥¸ ìŠ¤ë ˆë“œì˜ ìƒíƒœë¥¼ ë³µì›í•˜ëŠ” ê³¼ì •
        - CPUëŠ” í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì‹¤í–‰í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, **ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ì—¬ëŸ¬ ì‘ì—…ì„ ì‹¤í–‰í•˜ë ¤ë©´ ìŠ¤ë ˆë“œ ê°„ ì „í™˜(Context Switching)ì´ í•„ìš”**
        </aside>


1. **ë†’ì€ ë™ì‹œì„±(Concurrency) ì²˜ë¦¬ ëŠ¥ë ¥**
    - ì ì€ í”Œë«í¼ ìŠ¤ë ˆë“œë¡œë„ **ìˆ˜ë§Œ ê°œì˜ ë™ì‹œ ìš”ì²­ì„ ì²˜ë¦¬ ê°€ëŠ¥**
    - `ForkJoinPool`ì´ë‚˜ `CompletableFuture` ê°™ì€ ë³µì¡í•œ ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•Šê³ ë„ **ë¹„ë™ê¸°ì  ë™ì‘ ê°€ëŠ¥**
        - Future, CompletableFuture ì´ëŸ° ë³µì¡í•œ ë¹„ë™ê¸° API ì—†ì´ ì½”ë“œë¥¼ ì§¤ ìˆ˜ ìˆê¸°ì— ë””ìì¸ ì ìœ¼ë¡œ ë™ê¸°ì‹ìœ¼ë¡œ ê°€ëŠ¥
    - **ThreadLocal ì‚¬ìš© ê°€ëŠ¥** (í•˜ì§€ë§Œ ì¼ë¶€ ì œí•œ ìˆìŒ)

1. **ì¢…ë£Œ ê´€ë¦¬ ìš©ì´**
    - **JVMì´ í•„ìš”í•  ë•Œë§Œ ì‹¤í–‰í•˜ê³ , ì‚¬ìš©ì´ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ì •ë¦¬ë¨**.
        - ì‘ì—…ì´ ì œì¶œë  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ ê°€ìƒ ìŠ¤ë ˆë“œë¥¼ ìƒì„± í›„ ì‹¤í–‰í•œ ë’¤ ìë™ ì¢…ë£Œ
        - ë‹¤ë§Œ, **ì¥ì‹œê°„ ì‹¤í–‰ë˜ëŠ” ê°€ìƒ ìŠ¤ë ˆë“œ**ê°€ ìˆë‹¤ë©´ `try-with-resources` ë˜ëŠ” `close()`ë¥¼ í™œìš©í•´ ëª…í™•í•˜ê²Œ ì¢…ë£Œí•  ìˆ˜ë„ ìˆìŒ.

            ```kotlin
            try (ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor()) {
                executor.submit(() -> System.out.println("Virtual Thread Running"));
            }  // try ë¸”ë¡ì´ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ì¢…ë£Œë¨!
            ```

    - **ìë™ ê´€ë¦¬ë˜ëŠ” ìŠ¤ë ˆë“œ**ì´ë¯€ë¡œ `shutdown()`ì´ë‚˜ `close()`ë¥¼ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ë‹¤.
    - OSëŠ” ì¼ë°˜ì ìœ¼ë¡œ ìŠ¤ë ˆë“œ í’€ì„ ê´€ë¦¬í•˜ì§€ë§Œ, JVMì€ **ê°€ìƒ ìŠ¤ë ˆë“œë¥¼ í•„ìš”í•  ë•Œë§Œ ì‹¤í–‰**í•˜ì—¬ CPU ë¦¬ì†ŒìŠ¤ë¥¼ ìµœì í™”
    - ì¦‰, `ExecutorService`ê°€ **ê°€ìƒ ìŠ¤ë ˆë“œë¥¼ ê´€ë¦¬**í•˜ë¯€ë¡œ, **ì‚¬ìš©ìê°€ ì§ì ‘ ì¢…ë£Œí•  í•„ìš” X**

**ê°€ìƒ ìŠ¤ë ˆë“œì˜ ì£¼ìš” ì¥ì  ìš”ì•½**

| **ì¥ì ** | **ì„¤ëª…** |
| --- | --- |
| **1. ê²½ëŸ‰í™”ëœ ìŠ¤ë ˆë“œ** | ê¸°ì¡´ ìŠ¤ë ˆë“œë³´ë‹¤ í›¨ì”¬ ì ì€ ë©”ëª¨ë¦¬ ì‚¬ìš©, ìˆ˜ì²œ ê°œ ì´ìƒ ìƒì„± ê°€ëŠ¥ |
| **2. ë¸”ë¡œí‚¹ I/O ìµœì í™”** | ë¸”ë¡œí‚¹ ì‹œ OS ìŠ¤ë ˆë“œë¥¼ ì ìœ í•˜ì§€ ì•Šì•„ ì„±ëŠ¥ ì €í•˜ ì—†ìŒ |
| **3. ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ë¹„ìš© ì ˆê°** | JVMì´ ê´€ë¦¬í•˜ë¯€ë¡œ OS ë ˆë²¨ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ë³´ë‹¤ ë¹„ìš©ì´ ë‚®ìŒ |
| **4. ë†’ì€ ë™ì‹œì„± ì§€ì›** | ì ì€ OS ìŠ¤ë ˆë“œë¡œë„ ìˆ˜ë§ì€ ìš”ì²­ ì²˜ë¦¬ ê°€ëŠ¥ |
| **5. ì¢…ë£Œ ê´€ë¦¬ ìš©ì´** | ê°€ìƒ ìŠ¤ë ˆë“œëŠ” **ìë™ ê´€ë¦¬ë˜ëŠ” ìŠ¤ë ˆë“œì´ë‹¤.** |

**ìš”ì•½**

ê¸°ì¡´ í”Œë«í¼ ìŠ¤ë ˆë“œ(ì»¤ë„ ìŠ¤ë ˆë“œ)ë³´ë‹¤ ê°€ë³ê³ , ë™ì‹œì„±(Concurrency) ë†’ì€ ì‘ì—…ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë¨. íŠ¹íˆ ë¸”ë¡œí‚¹ I/O ì‘ì—…ì„ ë§ì´ ì²˜ë¦¬í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê°•ë ¥í•œ ì„±ëŠ¥

**ë‹¨ì **

**CPU ì§‘ì•½ì  ì‘ì—…ì—ëŠ” ì í•©í•˜ì§€ ì•ŠìŒ**

- ê°€ìƒ ìŠ¤ë ˆë“œëŠ” **ë¸”ë¡œí‚¹ I/O ì‘ì—…**ì— ìµœì í™”
- **ì´ìœ  ë¶„ì„**
    - **ê°€ìƒ ìŠ¤ë ˆë“œëŠ” OS ìŠ¤ë ˆë“œì™€ 1:1 ë§¤í•‘ë˜ì§€ ì•ŠìŒ** â†’ ì‹¤í–‰ ë„ì¤‘ ë‹¤ë¥¸ ê°€ìƒ ìŠ¤ë ˆë“œë¡œ êµì²´ë  ê°€ëŠ¥ì„±ì´ ìˆìŒ.
    - CPU ì—°ì‚°ì´ ëë‚  ë•Œê¹Œì§€ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ì´ ì ì€ **ê³ ì •ëœ í”Œë«í¼ ìŠ¤ë ˆë“œ**ê°€ ë” íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŒ.


**ê°€ìƒ ìŠ¤ë ˆë“œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë³‘ë ¬ì„±ì´ ì•„ë‹˜**

- ê°€ìƒ ìŠ¤ë ˆë“œëŠ” **ë™ì‹œì„±ì„ ë†’ì´ëŠ” ë°©ì‹**ìœ¼ë¡œ ë™ì‘í•¨
- ì¦‰, **ì½”ì–´ ê°œìˆ˜ë§Œí¼ ë³‘ë ¬ ì‹¤í–‰ë˜ì§€ëŠ” ì•Šê³ , ë§ì€ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ìµœì í™”**

**JVM ì˜¤ë²„í—¤ë“œ ì¦ê°€ ê°€ëŠ¥**

ê°€ìƒìŠ¤ë ˆë“œ ìì„¸í•œê±´ ë‚˜ì¤‘ì—

## ìƒì„± ì˜ˆì‹œ

### **V1 - ë¯¸ë¦¬ ë§Œë“¤ì–´ ë†“ê¸°**

```kotlin
private final ExecutorService ves = Executors.newVirtualThreadPerTaskExecutor();

public void executeTasks() {
    Future<?> future1 = ves.submit(() -> isExistUserForAsync(channelId));
    Future<?> future2 = ves.submit(() -> isExistChannelForAsync(channelId));

    try {
        future1.get(); // ì‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
        future2.get();
    } catch (InterruptedException | ExecutionException e) {
        e.printStackTrace();
    }
```

- ì´ë ‡ê²Œ ë¯¸ë¦¬ ìƒì„±í•´ë†“ê³  ê°–ë‹¤ ì¨ë„ ëœë‹¤

> But ë³„ë¡œë‹¤
>

**ë³„ë¡œì¸ ì´ìœ **

1. **ê°€ìƒ ìŠ¤ë ˆë“œëŠ” í’€(Pool)ì´ í•„ìš” ì—†ìŒ**
    - `newVirtualThreadPerTaskExecutor()`ëŠ” **ë§¤ ì‘ì—…ë§ˆë‹¤ ìƒˆë¡œìš´ ê°€ìƒ ìŠ¤ë ˆë“œë¥¼ ìƒì„±**í•˜ë¯€ë¡œ, `ExecutorService`ë¥¼ ë”°ë¡œ ìœ ì§€í•  í•„ìš”ê°€ ì—†ìŒ.
    - ê·¸ëƒ¥ **í•„ìš”í•  ë•Œ `Thread.startVirtualThread()`ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì´ ë” ì§ê´€ì ì´ê³  ì„±ëŠ¥ìƒ ìœ ë¦¬**.
2. **ë¶ˆí•„ìš”í•œ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬**
    - `newVirtualThreadPerTaskExecutor()`ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ **ForkJoinPool**ì„ ì‚¬ìš©í•˜ì§€ë§Œ, **ìŠ¤ë ˆë“œë¥¼ ì¬ì‚¬ìš©í•˜ì§€ ì•ŠìŒ**.
    - `ExecutorService`ë¥¼ ë¯¸ë¦¬ ìƒì„±í•´ ë†“ìœ¼ë©´ **ì¶”ê°€ì ì¸ ë©”ëª¨ë¦¬ ì ìœ ë§Œ í•˜ê³  ì‹¤ì§ˆì ì¸ ì¥ì ì´ ì—†ìŒ**.
3. **ì½”ë“œê°€ ë” ë³µì¡í•´ì§**
    - ë‹¨ìˆœíˆ `Thread.startVirtualThread()`ë¥¼ í˜¸ì¶œí•˜ë©´ ëë‚  ì¼ì„, `ExecutorService.submit()` í˜•íƒœë¡œ ê°ì‹¸ì•¼ í•´ì„œ ì½”ë“œê°€ ë³µì¡í•´ì§.

### V2 - ê·¸ë•Œ ê·¸ë•Œ ë§Œë“¤ê¸°

> ì´ ë°©ì‹ì´ íš¨ìœ¨ì ì´ì§€ë§Œ, **í¸ì˜ì„±ì€ V1ì´ ì¢‹ì•„ì„œ V1 or V3 ë§ì´ ì”€**
>

```kotlin
Thread vt1 = Thread.startVirtualThread(() -> isExistUserForAsync(channelId));
Thread vt2 = Thread.startVirtualThread(() -> isExistChannelForAsync(channelId));

vt1.join(); // ê¸°ë‹¤ë¦¬ê¸° 
vt2.join();

**[ë¦¬íŒ©í† ë§]**
List<Thread> threads = List.of(
        Thread.startVirtualThread(() -> isExistUserForAsync(userId)),
        Thread.startVirtualThread(() -> isExistChannelForAsync(channelId))
);
for (Thread thread : threads) {
    thread.join();
}

// ë°˜í™˜ ThreadëŠ” ê°€ìƒìŠ¤ë ˆë“œë‹¤.
```

- ì´ ë°©ì‹ì´ ë” ì§ê´€ì ì´ê³  ë©”ëª¨ë¦¬ íš¨ìœ¨ì 

### V3 - Callable ì‚¬ìš©(ë°˜í™˜ê°’ì´ í•„ìš”í•œ ê²½ìš°)

ì´ ì˜ˆì‹œëŠ” ã„±

```kotlin
    private final ExecutorService ves =  Executors.newVirtualThreadPerTaskExecutor();
    
        Callable<Integer> task1 = () -> {
            isExistUserForAsync(userId);
            return 3;
        };
        Callable<Integer> task2 = () -> {
            isExistChannelForAsync(channelId);
            return 32;
        };

        // ves.invokeAll(List.of(task1, task2));

        Future<Integer> future1 = ves.submit(task1);
        Future<Integer> future2 = ves.submit(task2);
        Integer result1 = future1.get();
        Integer result2 = future2.get();
        System.out.println(result1 + result2);
        
[ë¦¬íŒ©í† ë§]

Future<Integer> future1 = ves.submit(() -> {
    isExistUserForAsync(userId);
    return 3;
});
Future<Integer> future2 = ves.submit(() -> {
    isExistChannelForAsync(channelId);
    return 32;
});
Integer result1 = future1.get();
Integer result2 = future2.get();
System.out.println(result1 + result2);        
```

> **ExecutorServiceë¥¼ ì´ìš©í•´ Callable ì‘ì—…ì„ ì œì¶œí•˜ëŠ” ë°©ì‹**
>

(invokeAllì€ ê·¸ëƒ¥ ë„£ì–´ë´¤ìŒ)

- **ë°˜í™˜ê°’ ê´€ë¦¬**ê°€ ìš©ì´í•˜ê³ ,
- **ì—ëŸ¬ ì²˜ë¦¬**ë‚˜ **íƒ€ì„ì•„ì›ƒ** ì„¤ì • ë“± ë‹¤ì–‘í•œ ì˜µì…˜ì„ ì‰½ê²Œ ì ìš©í•  ìˆ˜ ìˆì–´ì„œ ì¼ë°˜ì ìœ¼ë¡œ ì„ í˜¸

### V4 - CompletableFutre vs  Future

```kotlin
    private final ExecutorService ves = Executors.newVirtualThreadPerTaskExecutor();
**

[Future ë°©ë²•1 - ì´ê²Œ ê·¸ëƒ¥ ê¹”ë”í•œë“¯]**
Future<?> future1 = ves.submit(() -> isExistUserForAsync(userId));
Future<?> future2 = ves.submit(() -> isExistChannelForAsync(channelId));
try {
    future1.get();
    future2.get();
} catch (ExecutionException e) {

**[Future ë°©ë²•2]**
List<Future<?>> futures = List.of(
    ves.submit(() -> isExistUserForAsync(userId)),
    ves.submit(() -> isExistChannelForAsync(channelId))
);

for (Future<?> future : futures) {
    future.get();
}

**[CompletableFutureë¥¼ ì“°ëŠ” ë°©ë²•]**
try {
    CompletableFuture.allOf(
        CompletableFuture.runAsync(() -> isExistUserForAsync(userId), ves),
        CompletableFuture.runAsync(() -> isExistChannelForAsync(channelId), ves)
    ).join();
} catch (CompletionException e) {
```

- ê°€ìƒ ì“°ë ˆë“œê°€ ë¹„ë™ê¸° ì§€ì›í•´ì„œ runAsyncì™€ ì½”ë“œê°€ ê²¹ì¹  ìˆ˜ ìˆì§€ë§Œ ê¹”ë”í•´ ë³´ì´ê¸´ í•¨
- But ê°€ìƒ ì“°ë ˆë“œê°€ ìˆëŠ”ë° êµ³ì´ CompletableFutureë¥¼ ê³µë¶€í•˜ê¸°ì—ëŠ” ì‹œê°„ì´ ë¶€ì¡±í•´ì„œ ê·¸ëƒ¥ ê°€ìƒ ìŠ¤ë ˆë“œ ë°©ë²•ì“°ì
- ì°¸ê³ ë¡œ Future<?> ì€ ì–´ë–¤ íƒ€ì…ì˜ ê°’ì´ë“  ë°˜í™˜í•  ìˆ˜ ìˆëŠ” Future ê°ì²´ë¼ëŠ” ëœ»
    - get() í˜¸ì¶œ ì‹œ Objectì²˜ë¦¬ë¨

## ë¹„ë™ê¸° ì²˜ë¦¬ì™€ ì‘ì—… ì™„ë£Œ ìˆœì„œê°€ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ì´ìœ 

> ë™ì‹œì„± ì‘ì—…ì´ ì‹œìŠ¤í…œì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì‚´í´ë³´ë©´ì„œ, ì‹œê°„ ìˆœì„œê°€ ë³´ì¥ë˜ì§€ ì•ŠëŠ” ì ì„ ì´í•´í•´ë³´ì
>

```kotlin
public static void main(String[] args) throws Exception{
  ExecutorService vtExecutor = Executors.newVirtualThreadPerTaskExecutor();

  IntStream.range(0, 10).forEach(i ->
          vtExecutor.submit(() -> {
              sleep(1000);
              System.out.println("ìš”ì²­ ì™„ë£Œ : " + i);
          })
  );
```

**ì°©ê°**

- ë¹„ë™ê¸° ì²˜ë¦¬ê°€ ì´ë£¨ì–´ì§„ë‹¤ê³ í•´ë„ forEachì—ì„œ 0~9ê¹Œì§€ ê° iê°’ì„ ê°–ëŠ” ì‘ì—…ì„ ìˆœì°¨ì ìœ¼ë¡œ ì œì¶œí•˜ë‹ˆê¹Œ **ë¨¼ì € ì œì¶œí•œ ìš”ì²­ì´ ë¨¼ì € ì²˜ë¦¬ë˜ì§€ ì•Šì„ê¹Œ????**
- **NO**

**ê²°ê³¼í‘œ**

```kotlin
ìš”ì²­ ì™„ë£Œ : 2
ìš”ì²­ ì™„ë£Œ : 9
ìš”ì²­ ì™„ë£Œ : 5
ìš”ì²­ ì™„ë£Œ : 1
ìš”ì²­ ì™„ë£Œ : 4
ìš”ì²­ ì™„ë£Œ : 6
ìš”ì²­ ì™„ë£Œ : 0
ìš”ì²­ ì™„ë£Œ : 3
ìš”ì²­ ì™„ë£Œ : 8
ìš”ì²­ ì™„ë£Œ : 7
```

0ë¶€í„° 9ê¹Œì§€ submitì´ í˜¸ì¶œë˜ëŠ” ìˆœì„œëŠ” ì¼ì •

- ê·¼ë°?? **ê²°ê³¼ê°€ ë’¤ì£½ë°•ì£½**ì´ë‹¤
- ë¹„ë™ê¸°ë¡œ ì‹¤í–‰ë˜ëŠ” ì‘ì—…ë“¤ì€ ê°ê° ë³„ë„ì˜ ìŠ¤ë ˆë“œ(ì—¬ê¸°ì„œëŠ” ê°€ìƒ ìŠ¤ë ˆë“œ)ì—ì„œ ë™ì‹œ ì‹¤í–‰ë˜ë¯€ë¡œ, **ì‹¤í–‰ ìˆœì„œë‚˜ ì™„ë£Œ ìˆœì„œëŠ” ì˜ˆì¸¡í•  ìˆ˜ ì—†ë‹¤**
- ì˜ˆë¡œ, 0ë²ˆ ì‘ì—…ì„ ê°€ì¥ ë¨¼ì € ì œì¶œí–ˆë”ë¼ë„ **â€œCPU ìŠ¤ì¼€ì¤„ë§â€**ì´ë‚˜ **â€œê¸°íƒ€ ìš”ì¸â€**ì— ì˜í•´ 9ë²ˆ ì¸ë±ìŠ¤ì˜ ì‘ì—…ì´ ë” ë¹¨ë¦¬ ì²˜ë¦¬ë  ìˆ˜ ìˆë‹¤.
    - **`submit()`ì„ í˜¸ì¶œí•œë‹¤ê³  ì¦‰ì‹œ ì‹¤í–‰ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ìŠ¤ë ˆë“œ ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì´ë¥¼ ì‹¤í–‰í•´ì•¼ í•˜ê¸° ë•Œë¬¸(ìš´ì˜ì²´ì œì˜ ìŠ¤ì¼€ì¥´ë§ì— ë”°ë¼ ì‹¤í–‰íë¦„ ê²°ì •ë¨)**
    - ì‘ì—…ì´ **ì–´ë–¤ CPU ì½”ì–´ì—ì„œ ì‹¤í–‰ë˜ëŠ”ì§€??**
    - í˜„ì¬ ì‹œìŠ¤í…œì´ **ì–¼ë§ˆë‚˜ ë°”ìœì§€??**
    - **I/O ëŒ€ê¸°ì‹œê°„, ìºì‹œ íˆíŠ¸ìœ¨, ë©”ëª¨ë¦¬ ìƒíƒœ** ë“±ì˜ ë‹¤ì–‘í•œ ìš”ì¸

> **ê²°ë¡ **
>
> - ë¹„ë™ê¸° ì‘ì—…ì€ ì‹¤í–‰ ìˆœì„œë¥¼ ë³´ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.
> - **ìš´ì˜ì²´ì œì˜ CPU ìŠ¤ì¼€ì¤„ë§ê³¼ ì—¬ëŸ¬ ìš”ì¸ì— ì˜í•´ ì‹¤í–‰ ìˆœì„œê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤**

## ì£¼ì˜í•  ì 

### ì˜ëª»ëœ ì‚¬ìš© 1

```kotlin
    public static void main(String[] args) throws Exception{
        ExecutorService vtExecutor = Executors.newVirtualThreadPerTaskExecutor();

        IntStream.range(0, 10).forEach(i ->
                vtExecutor.submit(() -> {
                    sleep(1000);
                    System.out.println("ìš”ì²­ ì™„ë£Œ : " + i);
                })
        );
        
        // ì•„ë˜ì˜ ì½”ë“œ ëˆ„ë½ 
        // vtExecutor.shutdown(); // ì‘ì—…ì„ ëª¨ë‘ ì œì¶œí•œ í›„ shutdown() í˜¸ì¶œ
        // vtExecutor.awaitTermination(Long.MAX_VALUE, java.util.concurrent.TimeUnit.MILLISECONDS); // ëª¨ë“  ì‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°
    }
```

- `ExecutorService`ëŠ” `submit()`ì„ í†µí•´ ì‘ì—…ì„ ìŠ¤ì¼€ì¤„ë§í•˜ì§€ë§Œ, ë©”ì¸ ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë˜ë©´ ì‘ì—…ì´ ì‹¤í–‰ë˜ì§€ ì•Šì€ ì±„ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë  ìˆ˜ ìˆìŒ.

### ì˜¬ë°”ë¥¸ ì‚¬ìš© 1

```kotlin
    public static void main(String[] args) throws Exception{
        ExecutorService vtExecutor = Executors.newVirtualThreadPerTaskExecutor();

        IntStream.range(0, 10).forEach(i ->
                vtExecutor.submit(() -> {
                    sleep(1000);
                    System.out.println("ìš”ì²­ ì™„ë£Œ : " + i);
                })
        );

        vtExecutor.shutdown();
        vtExecutor.awaitTermination(Long.MAX_VALUE, java.util.concurrent.TimeUnit.DAYS);
    }

ìš”ì²­ ì™„ë£Œ : 3
ìš”ì²­ ì™„ë£Œ : 0
ìš”ì²­ ì™„ë£Œ : 2
ìš”ì²­ ì™„ë£Œ : 1
ìš”ì²­ ì™„ë£Œ : 4
ìš”ì²­ ì™„ë£Œ : 5
ìš”ì²­ ì™„ë£Œ : 6
ìš”ì²­ ì™„ë£Œ : 7
ìš”ì²­ ì™„ë£Œ : 8
ìš”ì²­ ì™„ë£Œ : 9
```

- ê²°ê³¼ê°’ì€ ìˆœì„œëŒ€ë¡œ ë˜ëŠ”ê²Œ ì•„ë‹ˆë‹¤

### ì˜ëª»ëœ ì‚¬ìš© 2

```scss
try {
    Callable<?> submit1 = () -> {profile.deleteById(ProfileImgId()); return null;};
    Callable<?> submit2 = () -> {userStatusService.deleteByUserId(userId); return null;};
    Callable<?> submit3 = () -> {userRepository.delete(userId); return null;};
    ves.invokeAll(List.of(submit1, submit2, submit3));

```

![image.png](attachment:47fb7a58-26df-4067-a4e8-2a66c52725dd:image.png)

- ì‹œë„ : List.ofë¡œ Callable ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ê³  invokeAllì— ë„£ëŠ”ë‹¤
- `invokeAll()`ì€ Callable ì‘ì—…ë“¤ì„ ë„£ìœ¼ë©´ ë™ì‹œì— ë³‘ë ¬ ì‹¤í–‰
- `invokeAll()`ì€ **ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ë¸”ë¡œí‚¹ë¨**

### ì˜¬ë°”ë¥¸ ì‹œë„2

```scss

Callable<**Void**> submit1 = () -> {profile.deleteById(ProfileImgId()); return null;};
Callable<**Void**> submit2 = () -> {userStatusService.deleteByUserId(userId); return null;};
Callable<**Void**> submit3 = () -> {userRepository.delete(userId); return null;};
ves.invokeAll(List.of(submit1, submit2, submit3));
```

> `invokeAll(Collection<? extends Callable<T>> tasks)` ë©”ì„œë“œ
>
- í•˜ë‚˜ì˜ í†µì¼ëœ íƒ€ì… `T`ì— ëŒ€í•´ `Callable<T>`ë¥¼ ì—¬ëŸ¬ ê°œ ë°›ì•„ë“¤ì´ëŠ” êµ¬ì¡°
- Voidë¡œ í†µí•©í•´ì„œ í•œë²ˆì— ë„£ëŠ”ë‹¤

### ì˜¤í•´

```kotlin
// ê°€ìƒìŠ¤ë ˆë“œ ìƒì„±
private final ExecutorService ves = Executors.newVirtualThreadPerTaskExecutor();

try {
    Future<?> future1 = ves.submit(() -> isExistUserForAsync(userId));
    Future<?> future2 = ves.submit(() -> isExistChannelForAsync(channelId));

		// ê°€ìƒ ìŠ¤ë ˆë“œì—ì„œëŠ” get() í˜¸ì¶œì´ ë¸”ë¡œí‚¹ì´ì§€ë§Œ OS ìŠ¤ë ˆë“œë¥¼ ì ìœ í•˜ì§€ ì•ŠìŒ.
    // get()ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ë¹„ìš©ì´ ë‚®ê³ ,
    // ë¸”ë¡œí‚¹ ì‹œ ìë™ìœ¼ë¡œ ë‹¤ë¥¸ ê°€ìƒ ìŠ¤ë ˆë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì„±ëŠ¥ êµ¿
    future1.get();  // ë¸”ë¡œí‚¹ ë°œìƒ 
    future2.get();  // future1ì´ ëë‚œ í›„ ì‹¤í–‰
```

**ê¸°ì¡´ í”Œë ›í¼ ìŠ¤ë ˆë“œì˜€ë‹¤ë©´**

- future1 ì‘ì—…ì—ì„œ ë¸”ë¼í‚¹ì´ ë°œìƒí•˜ë©´ osìŠ¤ë ˆë“œë¥¼ ì ìœ í•œ ì±„ ê¸°ë‹¤ë ¸ë‹¤ê°€ future2ì´ ì§„í–‰ëœë‹¤.
- ì´ë¡œ ì¸í•´, OS ìŠ¤ë ˆë“œê°€ **ì•„ë¬´ê²ƒë„ í•˜ì§€ ëª»í•˜ê³  ëŒ€ê¸°í•˜ê³  ìŠ¤ë ˆë“œê°€ ë‚­ë¹„**

**ê°€ìƒ ìŠ¤ë ˆë“œ ì‚¬ìš© ì‹œ**

- ê°€ìƒ ìŠ¤ë ˆë“œëŠ” **ë¸”ë¡œí‚¹ ì‹œ í”Œë«í¼ ìŠ¤ë ˆë“œë¥¼ ì ìœ í•˜ì§€ ì•ŠìŒ**
- `future1.get();` í˜¸ì¶œ â†’ `future1`ì´ ì™„ë£Œë  ë•Œê¹Œì§€ **í•´ë‹¹ ê°€ìƒ ìŠ¤ë ˆë“œëŠ” ë¸”ë¡œí‚¹ë¨.**
- í•˜ì§€ë§Œ ê°€ìƒ ìŠ¤ë ˆë“œëŠ” **JVMì´ ìë™ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ë§**í•˜ê¸° ë•Œë¬¸ì—, **ëŒ€ê¸° ì¤‘ì¸ í”Œë«í¼ ìŠ¤ë ˆë“œë¥¼ í•´ì œí•˜ê³  ë‹¤ë¥¸ ê°€ìƒ ìŠ¤ë ˆë“œë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìˆìŒ.
- ì¦‰, `future1.get();`ì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ **OS ìŠ¤ë ˆë“œê°€ ë†€ì§€ ì•Šê³  `future2`ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŒ.**
- `future1`ì´ ëë‚˜ë©´ ë‹¤ì‹œ ì›ë˜ ì‹¤í–‰ë˜ë˜ ê°€ìƒ ìŠ¤ë ˆë“œê°€ ì´ì–´ì„œ ì‹¤í–‰ë¨.

**ê°€ìƒ ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œì˜ ì‹¤í–‰ íë¦„**

```scss

[ë©”ì¸ ìŠ¤ë ˆë“œ] â†’ future1.get() í˜¸ì¶œ (I/O ë¸”ë¡œí‚¹ ë°œìƒ)
[OS ìŠ¤ë ˆë“œ]  â†’ ëŒ€ê¸°í•˜ì§€ ì•Šê³  future2.get() ì‹¤í–‰ (ë‹¤ë¥¸ ê°€ìƒ ìŠ¤ë ˆë“œ ì²˜ë¦¬)
[ë©”ì¸ ìŠ¤ë ˆë“œ] â†’ future1 ì™„ë£Œ í›„ ë‹¤ì‹œ ì‹¤í–‰
```

ì¦‰, **future1 ê°€ìƒ ìŠ¤ë ˆë“œê°€ ë¸”ë¡œí‚¹ë˜ë”ë¼ë„ OS ìŠ¤ë ˆë“œë¥¼ ì ìœ í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ OSìŠ¤ë ˆë“œëŠ” ë‹¤ë¥¸ ì‘ì—…(futre2)ì´ ìˆ˜í–‰ë  ìˆ˜ ìˆìŒ. (**ë©”ì¸ ìŠ¤ë ˆë“œëŠ” ë¸”ë¡œí‚¹ ìƒíƒœë¡œ ìˆê³ )

âœ…**ê°€ìƒ ìŠ¤ë ˆë“œëŠ” ë¸”ë¡œí‚¹ì´ ë°œìƒí•´ë„ OS ìŠ¤ë ˆë“œë¥¼ ì ìœ í•˜ì§€ ì•ŠìŒ.**

âœ…**ê·¸ë ‡ê¸° ë•Œë¬¸ì— ë¹„ë™ê¸° ì²˜ë¦¬ ì—†ì´ë„ ë†’ì€ ë™ì‹œì„±ì„ ìœ ì§€í•  ìˆ˜ ìˆìŒ.**

âœ…**ê²°ê³¼ì ìœ¼ë¡œ CompletableFutureë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ ë¸”ë¡œí‚¹ ìŠ¤íƒ€ì¼ì˜ ì½”ë“œë¥¼ ìœ ì§€í•˜ë©´ì„œ ë†’ì€ ì„±ëŠ¥ì„ ë‚¼ ìˆ˜ ìˆìŒ.**

Springì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **ê°€ìƒ ìŠ¤ë ˆë“œ ê¸°ë°˜ `ScheduledTaskExecutor`ë¥¼ ì œê³µí•˜ì§€ ì•ŠìŒ**.

## **ê°€ìƒ ìŠ¤ë ˆë“œë¥¼ ì–¸ì œ ì‚¬ìš©í•´ì•¼ í• ê¹Œ?**

**âœ” ì‚¬ìš©í•˜ë©´ ì¢‹ì€ ê²½ìš°**

- **HTTP ìš”ì²­ì„ ë§ì´** ì²˜ë¦¬í•˜ëŠ” **ì›¹ ì„œë²„**
- ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬, íŒŒì¼ I/O ë“± **ë¸”ë¡œí‚¹ ì‘ì—…ì´ ë§ì€ ê²½ìš°**
- **ë†’ì€ ë™ì‹œì„±(Concurrency)ì´ í•„ìš”í•œ** ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜

**âŒ ì‚¬ìš©í•˜ë©´ ì„±ëŠ¥ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆëŠ” ê²½ìš°**

- **CPU ì—°ì‚°**ì´ ë§ì€ **ë©€í‹°ìŠ¤ë ˆë“œ ì—°ì‚° ì‘ì—…** (ì˜ˆ: ì´ë¯¸ì§€/ì˜ìƒ ì²˜ë¦¬, ë¹…ë°ì´í„° ë¶„ì„)
- **ì½”ì–´ ê°œìˆ˜ì— ìµœì í™”ëœ ì‘ì—…** (ê³ ì •ëœ ê°œìˆ˜ì˜ ìŠ¤ë ˆë“œê°€ íš¨ìœ¨ì ì¸ ê²½ìš°)
- ê¸°ì¡´ ë¸”ë¡œí‚¹ I/O ê¸°ë°˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ì‹œ (ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ê°€ìƒ ìŠ¤ë ˆë“œë¥¼ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸ í•„ìš”)

vt1.join();
vt2.join();

Thread vt1 = Thread.startVirtualThread(() -> isExistUserForAsync(channelId));
Thread vt2 = Thread.startVirtualThread(() -> isExistChannelForAsync(channelId));